<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Caress Canvas</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width" user-scalable="no">
    <style type="text/css">
        body {
            padding: 0;
            margin: 0;
            background-color: rgb(0, 200, 255);
        }
    </style>
</head>
<body onload="startup()">
<canvas id="canvas" width="1920" height="1080">
    You really badly need to use a different browser.
</canvas>

<!-- The Scripts -->
<script type="text/javascript" src="../scripts/vendor/jquery-1.8.1.min.js"></script>
<script type="text/javascript" src="../scripts/vendor/underscore-1.3.3.min.js"></script>
<script type="text/javascript" src="../scripts/vendor/socket.io-0.9.10.min.js"></script>
<script type="text/javascript" src="../scripts/input/wsTouch.js"></script>

<script>

    window.addEventListener('resize', function () {
        var canvas = document.getElementById('canvas');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }, false);

</script>

<script>
    var ongoingTouches = new Array;

    function startup() {

        var canvas = document.getElementById('canvas');
        window.client = new mmmTouch.Client({
            element: canvas,
            start: onStart,
            move: onMove,
            end: onEnd
        });
        client.connect();

        canvas.addEventListener("touchstart", handleStart, false);
        canvas.addEventListener("touchend", handleEnd, false);
        canvas.addEventListener("touchcancel", handleCancel, false);
        canvas.addEventListener("touchleave", handleEnd, false);
        canvas.addEventListener("touchmove", handleMove, false);
    }

    function onStart(cursor) {
        ongoingTouches.push(cursor);
    }

    function onMove(cursor) {
        var idx = ongoingTouchIndexById(cursor.identifier);
        ongoingTouches.splice(idx, 1, cursor);  // swap in the new touch record
    }

    function onEnd(cursor) {
        var idx = ongoingTouchIndexById(cursor.identifier);
        ongoingTouches.splice(idx, 1);  // remove it; we're done
    }

    function ongoingTouchIndexById(idToFind) {
        for (var i = 0; i < ongoingTouches.length; i++) {
            var id = ongoingTouches[i].identifier;

            if (id == idToFind) {
                return i;
            }
        }
        return -1;    // not found
    }

    function handleStart(evt) {
        evt.preventDefault();
        var touches = evt.changedTouches;

        for (var i = 0; i < touches.length; i++) {
            ongoingTouches.push(touches[i]);
        }

    }

    function handleMove(evt) {
        evt.preventDefault();
        var touches = evt.changedTouches;

        for (var i = 0; i < touches.length; i++) {
            var idx = ongoingTouchIndexById(touches[i].identifier);
            ongoingTouches.splice(idx, 1, touches[i]);  // swap in the new touch record
        }
    }

    function handleEnd(evt) {
        evt.preventDefault();
        var touches = evt.changedTouches;

        for (var i = 0; i < touches.length; i++) {
            var idx = ongoingTouchIndexById(touches[i].identifier);
            ongoingTouches.splice(idx, 1);  // remove it; we're done
        }

    }

    function handleCancel(evt) {
        evt.preventDefault();
        var touches = evt.changedTouches;

        for (var i = 0; i < touches.length; i++) {
            ongoingTouches.splice(i, 1);  // remove it; we're done
        }
    }

    function wsTouchToLocal(touch) {
        touch.clientX = window.innerWidth * touch.x;
        touch.clientY = window.innerHeight * touch.y;
        touch.pageX = document.documentElement.clientWidth * touch.x;
        touch.pageY = document.documentElement.clientHeight * touch.y;
        touch.target = document.elementFromPoint(touch.pageX, touch.pageY);
        touch.screenX = screen.width * touch.x;
        touch.screenY = screen.height * touch.y;
        return touch;
    }

    function wsStart(event) {
        ongoingTouches.push(event.detail);
    }

    function wsMove(event) {
        var touch = event.detail;
        var idx = ongoingTouchIndexById(touch.identifier);
        ongoingTouches.splice(idx, 1, touch);  // swap in the new touch record
    }

    function wsEnd(event) {
        var touch = event.detail;
        var idx = ongoingTouchIndexById(touch.identifier);
        ongoingTouches.splice(idx, 1);  // remove it; we're done
    }

    function draw() {
        requestAnimationFrame(draw);

        var el = document.getElementById("canvas");
        var ctx = el.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#ffffff";

        var radius = window.innerWidth / 40;

        for (var i = 0; i < ongoingTouches.length; i++) {
            var touch = ongoingTouches[i];
            ctx.beginPath();
            ctx.arc(touch.pageX, touch.pageY, radius, 0, 2 * Math.PI, false);
            ctx.fill();
        }
    }
    draw();

</script>
</body>
</html>